<%- include('../partials/header.ejs') %>

<div class="breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col">
                <p class="bread"><span><a href="/">Home</a></span> / <span>Shopping Cart</span></p>
            </div>
        </div>
    </div>
</div>

<div class="colorlib-product">
    <div class="container">
        <div class="row row-pb-lg">
            <div class="col-md-12">
                <div class="product-name d-flex">
                    <div class="one-forth text-left px-4">
                        <span>Product Details</span>
                    </div>
                    <div class="one-eight text-center">
                        <span>Price</span>
                    </div>
                    <div class="one-eight text-center">
                        <span>Quantity</span>
                    </div>
                    <div class="one-eight text-center">
                        <span>Total</span>
                    </div>
                    <div class="one-eight text-center px-4">
                        <span>Remove</span>
                    </div>
                </div>

                <% if (cart.items.length > 0) { %>
                    <% cart.items.forEach(function(item) { %>
                        <div class="product-cart d-flex">
                            <div class="one-forth">
                                <div class="product-img" style="background-image: url('<%= item.product_id.images[0] %>');">
                                </div>
                                <div class="display-tc">
                                    <h3><%= item.product_id.product_name %></h3>
                                </div>
                            </div>
                            <div class="one-eight text-center">
                                <div class="display-tc">
                                    <span class="price">$<%= item.price/item.quantity %></span>
                                </div>
                            </div>
                            <div class="one-eight text-center">
                                <div class="display-tc">
                                    <input type="text" name="quantity" class="form-control input-number text-center" value="<%= item.quantity %>" min="1" max="5">
                                </div>
                            </div>
                            <div class="one-eight text-center">
                                <div class="display-tc">
                                    <span class="price">$<%= item.price %></span>
                                </div>
                            </div>
                            <div class="one-eight text-center">
                                <div class="display-tc">
                                   <button class="btn btn-secondary" onclick="removeFromCart('<%= cart.user_id %>', '<%= item.product_id._id %>')">Delete</button>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p>Your cart is empty.</p>
                <% } %>

            </div>
        </div>
        <div class="row row-pb-lg">
            <div class="col-md-12">
                <div class="total-wrap">
                    <div class="row">
                        <div class="col-sm-4 text-center">
                            <div class="total">
                                <div class="sub">
                                    <p><span>Subtotal:</span> <span>$<%= cart.total_price %></span></p>
                                    <p><span>Delivery:</span> <span>$0.00</span></p>
                                    <p><span>Discount:</span> <span>$0.00</span></p>
                                </div>
                                <div class="grand-total">
                                    <p><span><strong>Total:</strong></span> <span>$<%= cart.total_price %></span></p>
                                </div>
                                <div>
                                    <% if (cart.items.length > 0) { %>
                                        <div>
                                            <a href="/checkout" class="btn btn-primary">Checkout</a>
                                        </div>
                                    <% }else{ %>
                                        <a href="/shop" class="btn btn-primary">add products</a>
                                        <%}%>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-8 offset-sm-2 text-center colorlib-heading colorlib-heading-sm">
                <h2>Related Products</h2>
            </div>
        </div>
        <div class="row">
            <% products.forEach(function(product) { %>
                <div class="col-md-3 col-lg-3 mb-4 text-center">
                    <div class="product-entry border">
                        <a href="/product-view/<%= product._id %>" class="prod-img">
                            <img src="<%= product.images[0] %>" class="img-fluid" alt="<%= product.product_name %>">
                        </a>
                        <div class="desc">
                            <h2><a href="#"><%= product.product_name %></a></h2>
                            <span class="price">$<%= product.price %></span> 
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
        

    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function removeFromCart(userId, productId) {
    fetch('/cart/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userId, productId }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            Swal.fire({
                title: "Success!",
                text: data.message,
                icon: "success",
                timer: 1500,
                showConfirmButton: false
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: "Error!",
            text: "Something went wrong. Please try again.",
            icon: "error",
            timer: 1500,
            showConfirmButton: false
        });
    });
}


</script>
<%- include('../partials/footer.ejs') %>
