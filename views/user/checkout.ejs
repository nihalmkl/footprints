
<%- include('../partials/header.ejs') %>
<style>
.addAddress{
    font-size: 16px;
    display: flex;
    align-items: center; 
    justify-content: center;
    
}

.addAddress:hover {
    background-color: #29302a; 
}
</style>
<div class="colorlib-product">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="col-md-12">
                    <div class="form-group">
                        <label for="address">Select Address</label>
                        <div class="form-field">
                            <i class="icon icon-arrow-down3"></i>
                            <select name="address" id="address" class="form-control">
                                <option value="#">Select Address</option>
                                <% if (addresses && addresses.length > 0) { %>
                                    <% addresses.forEach(address => { %>
                                        <option value="<%= address._id %>">
                                            <%= address.full_name %> - <%= address.street_address %>, <%= address.city %>, <%= address.state %> - <%= address.pincode %>, <%= address.country %>
                                        </option>
                                    <% }) %>
                                <% } else { %>
                                    <option value="">No addresses found</option>
                                <% } %>
                            </select>
                        </div>
                    </div>
                </div>
                        
                <form method="POST" class="colorlib-form">
                    <h2>Address Details</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fname">Full Name</label>
                                <input type="text" id="fname" class="form-control" placeholder="Your firstname">
                                <small id="fullNameErr" class="text-danger"></small>
                            </div>
                        </div>
                
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="address">Address</label>
                                <input type="text" id="address" class="form-control" placeholder="Enter Your Address">
                                <small id="addressErr" class="text-danger"></small>
                            </div>
                        </div>
                
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="country">Country</label>
                                    <input type="text" name="country" id="country" class="form-control" placeholder="Country">
                                    <small id="countryErr" class="text-danger"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="towncity">City</label>
                                    <input type="text" id="towncity" class="form-control" placeholder="City">
                                    <small id="cityErr" class="text-danger"></small>
                                </div>
                            </div>
                        </div>
                
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="stateprovince">State</label>
                                    <input type="text" id="stateprovince" class="form-control" placeholder="State ">
                                    <small id="stateErr" class="text-danger"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="zippostalcode">PinCode</label>
                                    <input type="text" id="zippostalcode" class="form-control" placeholder="ZipCode">
                                    <small id="zipErr" class="text-danger"></small>
                                </div>
                            </div>
                        </div>
                
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="email">E-mail Address</label>
                                    <input type="text" id="email" class="form-control" placeholder="Email">
                                    <small id="emailErr" class="text-danger"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="text" id="phone" class="form-control" placeholder="Phone Number">
                                    <small id="phoneErr" class="text-danger"></small>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary address-button" onclick="createAddress(event)">Create</button>
                    </div>
                </form>
                
            </div>

            <div class="col-lg-4">
                <div class="row">
                    <div class="col-md-12">
                        <div class="cart-detail">
                            <h2>Cart Total</h2>
                            <ul>
                                <li>
                                    <span><strong>Product</strong></span> <span><strong>Amount</strong></span>
                                    <ul>
                                        <% if (typeof cart.items !='undefined' ) { %>
                                            <% cart.items.forEach(item=> { %>
                                                <li><span>
                                                        <%= item.quantity %> x <%= item.product_id.product_name%>
                                                    </span> 
                                                    <span>
                                                        <%= item.price %>
                                                    </span></li>
                                                <% }) %>
                                                    <% } %>
                                    </ul>
                                </li>
                                <li id="discount-div"><span>Discount</span> 
                                <span id="discount-price-div">
                                    <%= cart.items.product_id.delivery_charge %>
                                </span></li>
                                <li><span>Order Total</span> <span id="ordertotal">
                                        <%= cart.total_price%>
                                    </span></li>
                            </ul>
                        </div>
                    </div>

                   <div class="w-100"></div>
                   <div class="col-md-12">
                    <div class="cart-detail">
                        <h2>Use Coupon Code</h2>
                        <div class="discount-code-wrapper mb-4 p-4">
                            <div class="discount-code">
                                <p class="mb-0">
                                    <a id="openModal" class="text-primary" href="#">Available Coupons</a>
                                </p>
                                <div class="text-success" id="coupon-success"></div>
                
                                <!-- Coupon Modal -->
                                <div id="couponModal" class="modal">
                                    <div class="modal-content">
                                        <span class="close">&times;</span>
                                        <h2>Coupon Details</h2>
                                        <% if (typeof coupons != 'undefined') { %>
                                            <p style="color: rgb(43, 109, 81);" >Here are some great coupons for you:</p>
                                            <hr>
                                            <% coupons.forEach(val => { %>
                                                <ul>
                                                    <li>Coupon name: <%= val.name %></li>
                                                    <li>Code: <a id="couponCode<%= val.id %>"><%= val.code %></a></li>
                                                    <li>Discount: <%= val.discountAmount %></li>
                                                    <li>End Date: <%= val.endDate.toLocaleDateString('en-GB') %></li>
                                                    <li>Min Purchase Amount: <%= val.minPurchaseAmount %></li>
                                                    <li><a style="color: rgb(80, 80, 251);" onclick="copyCode(event, '<%= val.id %>')" href="#">Copy Code</a></li>
                                                </ul>
                                                <hr>
                                            <% }) %>
                                        <% } else { %>
                                            <p>No coupons available at the moment.</p>
                                        <% } %>
                                    </div>
                                </div>
                
                                <form class="d-flex flex-column">
                                    <input type="text" required id="coupon-code" class="mb-2" placeholder="Enter Coupon Code" />
                                    <div class="d-flex justify-content-between">
                                        <button class="cart-btn-2 btn btn-primary" onclick="applycoupon(event)" type="button">Apply Coupon</button>
                                        <button onclick="reload(event)" class="cart-btn-2 bg-secondary btn btn-secondary" type="button">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
             </div>

                <div class="col-md-12">
                    <div class="cart-detail">
                        <h2>Payment Method</h2>
                        <div class="form-group">
                            <div class="col-md-12">
                                <div class="radio">
                                    <label><input type="radio" name="payment_method" value="card" required>Card</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-12">
                                <div class="radio">
                                    <label><input type="radio" name="payment_method" value="COD">Cash on Delivery</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 text-center">
                        <p><a href="" class="btn btn-primary place-order" onclick="placeOrder()">Place an order</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function createAddress(event) {
    event.preventDefault();

    const fullName = document.getElementById('fname').value;
    const address = document.getElementById('address').value;
    const city = document.getElementById('towncity').value;
    const state = document.getElementById('stateprovince').value;
    const zipcode = document.getElementById('zippostalcode').value;
    const phone = document.getElementById('phone').value;
    const country = document.getElementById('country').value;
    const email = document.getElementById('email').value;

    const phoneErr = document.getElementById('phoneErr');
    const zipErr = document.getElementById('zipErr');
    const fullNameErr = document.getElementById('fullNameErr');
    const addressErr = document.getElementById('addressErr');
    const cityErr = document.getElementById('cityErr');
    const stateErr = document.getElementById('stateErr');
    const countryErr = document.getElementById('countryErr');
    const emailErr = document.getElementById('emailErr');

    [phoneErr, zipErr, fullNameErr, addressErr, cityErr, stateErr, countryErr, emailErr].forEach(err => {
        if (err) err.innerHTML = '';
    });

    const phoneRegex = /^[0-9]{10}$/;
    const zipRegex = /^[0-9]{6}(?:-[0-9]{4})?$/;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    let isValid = true;

    if (!phoneRegex.test(phone)) {
        phoneErr.innerHTML = "Invalid phone number";
        isValid = false;
    }

    if (fullName === "") {
        fullNameErr.innerHTML = "Full name is required";
        isValid = false;
    }

    if (city === "") {
        cityErr.innerHTML = "City is required";
        isValid = false;
    }

    if (state === "") {
        stateErr.innerHTML = "State is required";
        isValid = false;
    }

    if (country === "") {
        countryErr.innerHTML = "Country is required";
        isValid = false;
    }

    if (!emailRegex.test(email)) {
        emailErr.innerHTML = "Invalid email address";
        isValid = false;
    }

    if (!zipRegex.test(zipcode)) {
        zipErr.innerHTML = "Invalid Pincode";
        isValid = false;
    }

    if (!isValid) {
        Swal.fire({
            title: "Error!",
            text: "Please fill all fields correctly.",
            icon: "error",
            timer: 1500,
            showConfirmButton: false
        });
        return;
    }

    const userId = "<%= userId %>";
    const data = {
        full_name: fullName,
        street_address: address,
        pincode: zipcode,
        city: city,
        phone: phone,
        country: country,
        state: state,
        user_id: userId
    };

    console.log("Form is valid. Proceed with submission.", data);

            console.log(data)
        fetch('/address/add-address', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                title: "Success",
                text: "Address added successfully",
                icon: "success",
                timer: 1500,
                showConfirmButton: false
            }).then(()=>{
                window.location.reload();
            })
            } else {
                Swal.fire({
                title: "failed",
                text: "Failure in Address adding ",
                icon: "error",
                timer: 1500,
            })

            }
        })
        .catch((error) => {
            console.error('Error:', error);
            Swal.fire({
                title: "Error!",
                text: "Please try again later",
                icon: "error",
                timer: 1500,
                showConfirmButton: false
            });
        });
    }
</script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    async function placeOrder() {
  const addressId = document.getElementById("address").value;
  const paymentMethod = document.querySelector('input[name="payment_method"]:checked');

  if (addressId === "#" || !paymentMethod) {
    Swal.fire({ 
        title: "Error",
        text: "Please select address and payment method.",
        icon: "error", 
        timer: 1500, 
        showConfirmButton: false 
    });
    return;
  }

  const orderData = { address_id: addressId, payment_method: paymentMethod.value };

  try {
    const response = await fetch('/place-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orderData)
    });

    if (response.ok) {
      const result = await response.json();

      if (paymentMethod.value === "COD") {
        Swal.fire({ title: "Success", text: "Order placed successfully!", icon: "success", timer: 1500, showConfirmButton: false })
          .then(() => { window.location.href = '/profile'; });
      } else {
        const { razorpayOrderId, amount } = result;
        handleRazorpayPayment(razorpayOrderId, amount);
      }
    } else {
      Swal.fire({ title: "Error", text: "Failed to place the order.", icon: "error", timer: 1500, showConfirmButton: false });
    }
  } catch (error) {
    Swal.fire({ title: "Error", text: "Internal server error", icon: "error", timer: 1500, showConfirmButton: false });
  }
}

function handleRazorpayPayment(orderId, amount) {
  const options = {
    key: 'rzp_test_MoQOrZAlepfiB7',
    amount: amount * 100,
    name:"FootPrints",
    currency: "INR",
    order_id: orderId,
    handler: function (response) {
      alert(`Payment successful. Razorpay Payment ID: ${response.razorpay_payment_id}`);
      window.location.href = '/order-success';
    },
    theme: {
      color: "#3399cc"
    }
  };

  const rzp = new Razorpay(options);
  rzp.open();
}


document.querySelector('.place-order').addEventListener('click', (event) => {
    event.preventDefault();  
    placeOrder(); 
});

</script>
    
<%- include('../partials/footer.ejs') %>