
<%- include('../partials/header.ejs') %>
<style>
.addAddress{
    font-size: 16px;
    display: flex;
    align-items: center; 
    justify-content: center;
    
}

.addAddress:hover {
    background-color: #29302a; 
}
</style>
<div class="colorlib-product">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="col-md-12">
                    <div class="form-group">
                        <label for="address">Select Address</label>
                        <div class="form-field">
                            <i class="icon icon-arrow-down3"></i>
                            <select name="address" id="address" class="form-control">
                                <option value="#">Select Address</option>
                                <% if (addresses && addresses.length > 0) { %>
                                    <% addresses.forEach(address => { %>
                                        <option value="<%= address._id %>">
                                            <%= address.full_name %> - <%= address.street_address %>, <%= address.city %>, <%= address.state %> - <%= address.pincode %>, <%= address.country %>
                                        </option>
                                    <% }) %>
                                <% } else { %>
                                    <option value="">No addresses found</option>
                                <% } %>
                            </select>
                        </div>
                    </div>
                </div>
                        
                <form method="POST" class="colorlib-form">
                    <h2>Address Details</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fname">Full Name</label>
                                <input type="text" id="fname" class="form-control" placeholder="Your firstname">
                                <small id="fullNameErr" class="text-danger"></small>
                            </div>
                        </div>
                
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="address">Address</label>
                                <input type="text" id="address" class="form-control" placeholder="Enter Your Address">
                                <small id="addressErr" class="text-danger"></small>
                            </div>
                        </div>
                
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="country">Country</label>
                                    <input type="text" name="country" id="country" class="form-control" placeholder="Country">
                                    <small id="countryErr" class="text-danger"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="towncity">City</label>
                                    <input type="text" id="towncity" class="form-control" placeholder="City">
                                    <small id="cityErr" class="text-danger"></small>
                                </div>
                            </div>
                        </div>
                
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="stateprovince">State</label>
                                    <input type="text" id="stateprovince" class="form-control" placeholder="State ">
                                    <small id="stateErr" class="text-danger"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="zippostalcode">ZipCode</label>
                                    <input type="text" id="zippostalcode" class="form-control" placeholder="ZipCode">
                                    <small id="zipErr" class="text-danger"></small>
                                </div>
                            </div>
                        </div>
                
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="email">E-mail Address</label>
                                    <input type="text" id="email" class="form-control" placeholder="Email">
                                    <small id="emailErr" class="text-danger"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="text" id="phone" class="form-control" placeholder="Phone Number">
                                    <small id="phoneErr" class="text-danger"></small>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary address-button" onclick="createAddress(event)">Create</button>
                    </div>
                </form>
                
            </div>

            <div class="col-lg-4">
                <div class="row">
                    <div class="col-md-12">
                        <div class="cart-detail">
                            <h2>Cart Total</h2>
                            <ul>
                                <li>
                                    <span>Subtotal</span> <span>$<%= cart.total_price %></span>
                                    
                                </li>
                                <li><span>Shipping</span> <span>$0.00</span></li>
                                <li><span>Order Total</span> <span>$<%= cart.total_price %></span></li>
                            </ul>
                        </div>
                   </div>

                   <div class="w-100"></div>

                   <div class="col-md-12">
                    <div class="cart-detail">
                        <h2>Payment Method</h2>
                        <div class="form-group">
                            <div class="col-md-12">
                                <div class="radio">
                                    <label><input type="radio" name="payment_method" value="Bank Transfer" required>Bank Transfer</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-12">
                                <div class="radio">
                                    <label><input type="radio" name="payment_method" value="Cash on Delivery">Cash on Delivery</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 text-center">
                        <p><a href="" class="btn btn-primary place-order" onclick="placeOrder()">Place an order</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function createAddress(event) {
    event.preventDefault();

    const fullName = document.getElementById('fname').value;
    const address = document.getElementById('address').value;
    const city = document.getElementById('towncity').value;
    const state = document.getElementById('stateprovince').value;
    const zipcode = document.getElementById('zippostalcode').value;
    const phone = document.getElementById('phone').value;
    const country = document.getElementById('country').value;
    const email = document.getElementById('email').value;

    const phoneErr = document.getElementById('phoneErr');
    const zipErr = document.getElementById('zipErr');
    const fullNameErr = document.getElementById('fullNameErr');
    const addressErr = document.getElementById('addressErr');
    const cityErr = document.getElementById('cityErr');
    const stateErr = document.getElementById('stateErr');
    const countryErr = document.getElementById('countryErr');
    const emailErr = document.getElementById('emailErr');

    // Clear previous errors
    [phoneErr, zipErr, fullNameErr, addressErr, cityErr, stateErr, countryErr, emailErr].forEach(err => {
        if (err) err.innerHTML = '';
    });

    // Regex for phone and zip validation
    const phoneRegex = /^[0-9]{10}$/;
    const zipRegex = /^[0-9]{5}(?:-[0-9]{4})?$/;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    let isValid = true;

    if (!phoneRegex.test(phone)) {
        phoneErr.innerHTML = "Invalid phone number";
        isValid = false;
    }

    if (fullName === "") {
        fullNameErr.innerHTML = "Full name is required";
        isValid = false;
    }

    if (address === "") {
        addressErr.innerHTML = "Address is required";
        isValid = false;
    }

    if (city === "") {
        cityErr.innerHTML = "City is required";
        isValid = false;
    }

    if (state === "") {
        stateErr.innerHTML = "State is required";
        isValid = false;
    }

    if (country === "") {
        countryErr.innerHTML = "Country is required";
        isValid = false;
    }

    if (!emailRegex.test(email)) {
        emailErr.innerHTML = "Invalid email address";
        isValid = false;
    }

    if (!zipRegex.test(zipcode)) {
        zipErr.innerHTML = "Invalid Zip Code";
        isValid = false;
    }

    if (!isValid) {
        Swal.fire({
            title: "Error!",
            text: "Please fill all fields correctly.",
            icon: "error",
            timer: 1500,
            showConfirmButton: false
        });
        return;
    }

    // Submit or further process data
    const userId = "<%= userId %>"; // Assuming this is available
    const data = {
        full_name: fullName,
        street_address: address,
        pincode: zipcode,
        city: city,
        phone: phone,
        country: country,
        state: state,
        user_id: userId
    };

    console.log("Form is valid. Proceed with submission.", data);

            console.log(data)
        fetch('/address/add-address', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(data.message);
            } else {
                Swal.fire({
                title: "Success",
                text: "Address added successfully",
                icon: "success",
                timer: 1500,
                showConfirmButton: false
            });

            }
        })
        .catch((error) => {
            console.error('Error:', error);
            Swal.fire({
                title: "Error!",
                text: "Please try again later",
                icon: "error",
                timer: 1500,
                showConfirmButton: false
            });
        });
    }
</script>
<script>
    async function placeOrder() {
        console.log('heiaoifd')
        const addressId = document.getElementById("address").value;
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked');

        if (addressId === "#") {
            Swal.fire({
                title: "Error",
                text: "please select address",
                icon: "error",
                timer: 1500,
                showConfirmButton: false
            })
            return;
        }
        if(!paymentMethod){
            Swal.fire({
                title: "Error",
                text: "please select payment method",
                icon: "error",
                timer: 1500,
                showConfirmButton: false
            })
            return
        }
        const orderData = {
            address_id: addressId,
            payment_method: paymentMethod.value,
        };

        try {
            const response = await fetch('/place-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData),
            });

            if (response.ok) {
                const result = await response.json();
                Swal.fire({
                    title:'Success',
                    icon:"success",
                    text:"Order placed successfully!",
                    timer:1500,
                    showConfirmButton:false
                })
                return
            } else {
                Swal.fire({
                title: "Error",
                text: "Failed to place the order. Please try again.",
                icon: "error",
                timer: 1500,
                showConfirmButton: false
            })
            }
        } catch (error) {
            Swal.fire({
                title: "Error",
                text: "Internal server error",
                icon: "error",
                timer: 1500,
                showConfirmButton: false
            })
        }
    }

    document.querySelector('.place-order').addEventListener('click', (event) => {
        event.preventDefault();  
        placeOrder(); 
    })
</script>
    
<%- include('../partials/footer.ejs') %>